@page "/tickets/form/{id:long}/"

@using HelpDesk.Models.Dto.Auth
@using HelpDesk.Services.Tickets
@using HelpDesk.Utils
@using HelpDesk.Models.PLA.Tickets
@using HelpDesk.Components.Pages.Tickets.Forms.Components
@using HelpDesk.Models.Enums.Identity

@inject TicketService TicketService
@inject StorageSession Session

<MudText Typo="Typo.h6" GutterBottom="true" Align="Align.Start">@_ticket?.Title</MudText>
<MudText Typo="Typo.body2" GutterBottom="true" Align="Align.Start">№ @_ticket?.Id</MudText>

@if (!string.IsNullOrEmpty(_errorMsg))
{
    <MudAlert Severity="Severity.Error" Class="mt-2" ShowCloseIcon="true" CloseIconClicked="() => _errorMsg = string.Empty">
        @_errorMsg
    </MudAlert>
}

<MudGrid>
    <MudItem xs="12" sm="6">
        <MudPaper Class="mt-2 " Elevation="0">
            <MudForm>
                <AuthorOfTicket Ticket="_ticket"/>
                <DetailsOfTicket Ticket="_ticket" DeskToken="_deskToken"
                                 LoadTicketDelegate="_loadTicketDelegate"/>
                <DeviceInUseOfTicket Ticket="_ticket" DeskToken="_deskToken"
                                     LoadTicketDelegate="_loadTicketDelegate"/>
                <DocumentInUseOfTicket Ticket="_ticket" DeskToken="_deskToken"
                                       LoadTicketDelegate="_loadTicketDelegate"/>
            </MudForm>
        </MudPaper>
        <MudPaper Class="mt-2" Elevation="0">
        </MudPaper>
        <MudPaper Class="mt-2" Elevation="0">

        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6">
        <MudPaper Style="padding: 25px; overflow: auto; max-height: calc(100vh - 28vh); " Elevation="9">
            <ChatOfTicket Ticket="_ticket" DeskToken="_deskToken"
                          LoadTicketDelegate="_loadTicketDelegate"/>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {

    [Parameter] public long Id { get; set; }
    private string _errorMsg = string.Empty;
    private TicketView _ticket = new();
    private DeskToken _deskToken = new();

    public delegate Task LoadTicketDelegate();

    public LoadTicketDelegate? _loadTicketDelegate;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        _deskToken = await Session.GetCurrentAccessToken();
        _loadTicketDelegate += LoadTicket;
        await LoadTicket();
    }


    public async Task LoadTicket()
    {
        try
        {
            _ticket = await TicketService.GetTicket(Id) ?? throw new Exception("Не удалось загрузить тикет");
            if ((_ticket.UserId != _deskToken.Id) && _deskToken.IdentityType is not IdentityType.TechSupport)
            {
                _ticket = new TicketView();
                throw new Exception("У вас нет прав на просмотр заявок, которые Вы не создавали");
            }

            StateHasChanged();
        }
        catch (Exception e)
        {
            _errorMsg = e.Message;
        }
    }

}